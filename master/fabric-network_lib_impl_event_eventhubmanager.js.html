<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: fabric-network/lib/impl/event/eventhubmanager.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: fabric-network/lib/impl/event/eventhubmanager.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Copyright 2019 IBM All Rights Reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
'use strict';
const EventHubFactory = require('./eventhubfactory');
const logger = require('fabric-network/lib/logger').getLogger('EventHubManager');
/**
 * The Event Hub Manager is responsible for creating and distributing event hubs.
 * It uses the event hub factory to reuse event hubs that exists, and maintains
 * its own list of new event hubs that are used for event replay
 * @memberof module:fabric-network
 * @class
 */
class EventHubManager {
    /**
     * Constructor
     * @param {module:fabric-network.Network} network The network
     */
    constructor(network) {
        this.channel = network.getChannel();
        this.eventHubFactory = new EventHubFactory(this.channel);
        this.eventHubSelectionStrategy = network.getEventHubSelectionStrategy();
        this.newEventHubs = [];
    }
    /**
     * Gets an event hub. If given a peer, it will get that peers event hub, otherwise
     * it will get the next peer defined by the {@link EventHubSelectionStrategy}
     * @param {Peer} peer A peer instance
     * @param {boolean} filtered Flag to decide between filtered and unfiltered events
     * @returns {ChannelEventHub} The event hub
     */
    getEventHub(peer, filtered) {
        if (!peer) {
            peer = this.eventHubSelectionStrategy.getNextPeer();
        }
        peer = peer.getPeer ? peer.getPeer() : peer;
        const eventHub = this.eventHubFactory.getEventHub(peer);
        if (eventHub.isconnected() &amp;&amp; eventHub.isFiltered() !== !!filtered) {
            return this.getReplayEventHub(peer);
        }
        this.log();
        return eventHub;
    }
    /**
     * Gets a list of event hubs from the {@link EventHubFactory} for a list of peers
     * @param {Peer[]} peers A list of peer instances
     */
    getEventHubs(peers) {
        this.log();
        return this.eventHubFactory.getEventHubs(peers);
    }
    /**
     * Gets a new event hub instance for a give peer and updates the list of new event
     * hubs that have been created
     * @param {Peer} peer A peer instance
     * @returns {ChannelEventHub} The event hub
     */
    getReplayEventHub(peer) {
        for (const index in this.newEventHubs) {
            const eventHub = this.newEventHubs[index];
            if (!eventHub.isconnected() &amp;&amp; this._isNewEventHub(eventHub) &amp;&amp; (!peer || eventHub.getName() === peer.getName())) {
                this.newEventHubs.splice(index, 1);
            }
        }
        peer = this.eventHubSelectionStrategy.getNextPeer();
        const eh = this.channel.newChannelEventHub(peer);
        this.newEventHubs.push(eh);
        this.log();
        return eh;
    }
    /**
     * Will get a new event hub instance without the possibility of selecting a new peer
     * @param {Peer} peer A peer instance
     * @returns {ChannelEventHub} The event hub
     */
    getFixedEventHub(peer) {
        const eventHub = this.channel.newChannelEventHub(peer);
        this.newEventHubs.push(eventHub);
        this.log();
        return eventHub;
    }
    /**
     * When called with a peer, it updates the {@link EventHubSelectionStrategy} with the
     * new status of a peer to allow for intelligent strategies
     * @param {Peer} deadPeer A peer instance
     */
    updateEventHubAvailability(deadPeer) {
        return this.eventHubSelectionStrategy.updateEventHubAvailability(deadPeer);
    }
    /**
     * Disconnect from and delete all event hubs
     */
    dispose() {
        this.eventHubFactory.dispose();
        this.newEventHubs.forEach((eh) => eh.disconnect());
    }
    getEventHubFactory() {
        return this.eventHubFactory;
    }
    getPeers() {
        return this.eventHubSelectionStrategy.getPeers();
    }
    /**
     * Check if an event hub has any registrations
     * @param {ChannelEventHub} eventHub An event hub instance
     * @returns {boolean}
     * @private
     */
    _isNewEventHub(eventHub) {
        if (!eventHub) {
            throw new Error('event hub not given');
        }
        const chaincodeRegistrations = Object.values(eventHub._chaincodeRegistrants).length;
        const blockRegistrations = Object.values(eventHub._blockRegistrations).length;
        const txRegistrations = Object.values(eventHub._transactionRegistrations).length;
        return (chaincodeRegistrations + blockRegistrations + txRegistrations) === 0;
    }
    log() {
        const factoryEventHubs = Array.from(this.eventHubFactory._savedEventHubs.values());
        const connectedFactoryEventHubs = factoryEventHubs.filter(eh => eh.original.isconnected());
        logger.debug(`Factory Event Hubs: ${connectedFactoryEventHubs.length}/${factoryEventHubs.length}`);
        const connectedReplayEventHubs = this.newEventHubs.filter(eh => eh.isconnected());
        logger.debug(`Replay Event Hubs: ${connectedReplayEventHubs.length}/${this.newEventHubs.length}`);
    }
}
module.exports = EventHubManager;
//# sourceMappingURL=eventhubmanager.js.map</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-fabric-network.html">fabric-network</a></li></ul><h3>Classes</h3><ul><li><a href="AffiliationService.html">AffiliationService</a></li><li><a href="BasePackager.html">BasePackager</a></li><li><a href="BasicCommitHandler.html">BasicCommitHandler</a></li><li><a href="BlockDecoder.html">BlockDecoder</a></li><li><a href="CertificateAuthority.html">CertificateAuthority</a></li><li><a href="Chaincode.html">Chaincode</a></li><li><a href="ChaincodeRegistration.html">ChaincodeRegistration</a></li><li><a href="Channel.html">Channel</a></li><li><a href="ChannelEventHub.html">ChannelEventHub</a></li><li><a href="ChannelPeer.html">ChannelPeer</a></li><li><a href="Client.html">Client</a></li><li><a href="CommitHandler.html">CommitHandler</a></li><li><a href="DiscoveryEndorsementHandler.html">DiscoveryEndorsementHandler</a></li><li><a href="EndorsementHandler.html">EndorsementHandler</a></li><li><a href="EndorsementPolicy.html">EndorsementPolicy</a></li><li><a href="Endpoint.html">Endpoint</a></li><li><a href="event_hub_number.html">event_hub_number</a></li><li><a href="FabricCAClient.html">FabricCAClient</a></li><li><a href="FabricCAServices.html">FabricCAServices</a></li><li><a href="IdentityService.html">IdentityService</a></li><li><a href="module-fabric-network.AbstractEventHubSelectionStrategy.html">AbstractEventHubSelectionStrategy</a></li><li><a href="module-fabric-network.AbstractEventListener.html">AbstractEventListener</a></li><li><a href="module-fabric-network.BaseCheckpointer.html">BaseCheckpointer</a></li><li><a href="module-fabric-network.CommitEventListener.html">CommitEventListener</a></li><li><a href="module-fabric-network.Contract.html">Contract</a></li><li><a href="module-fabric-network.ContractEventListener.html">ContractEventListener</a></li><li><a href="module-fabric-network.EventHubDisconnectError.html">EventHubDisconnectError</a></li><li><a href="module-fabric-network.EventHubManager.html">EventHubManager</a></li><li><a href="module-fabric-network.FabricError.html">FabricError</a></li><li><a href="module-fabric-network.FileSystemCheckpointer.html">FileSystemCheckpointer</a></li><li><a href="module-fabric-network.Gateway.html">Gateway</a></li><li><a href="module-fabric-network.HsmX509Provider.html">HsmX509Provider</a></li><li><a href="module-fabric-network.IdentityProviderRegistry.html">IdentityProviderRegistry</a></li><li><a href="module-fabric-network.Network.html">Network</a></li><li><a href="module-fabric-network.Query.html">Query</a></li><li><a href="module-fabric-network.RoundRobinEventHubSelectionStrategy.html">RoundRobinEventHubSelectionStrategy</a></li><li><a href="module-fabric-network.TimeoutError.html">TimeoutError</a></li><li><a href="module-fabric-network.Transaction.html">Transaction</a></li><li><a href="module-fabric-network.Wallet.html">Wallet</a></li><li><a href="module-fabric-network.Wallets.html">Wallets</a></li><li><a href="MSP.html">MSP</a></li><li><a href="MSPManager.html">MSPManager</a></li><li><a href="NetworkConfig_1_0.html">NetworkConfig_1_0</a></li><li><a href="Orderer.html">Orderer</a></li><li><a href="Organization.html">Organization</a></li><li><a href="Peer.html">Peer</a></li><li><a href="Remote.html">Remote</a></li><li><a href="TransactionID.html">TransactionID</a></li></ul><h3>Interfaces</h3><ul><li><a href="module-fabric-network.WalletStore.html">WalletStore</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-app-dev-env-setup.html">Setting up the Application Developer's Environment</a></li><li><a href="tutorial-chaincode-lifecycle.html">fabric-client: How to install and start your chaincode</a></li><li><a href="tutorial-channel-create.html">fabric-client: How to create a Hyperledger Fabric channel</a></li><li><a href="tutorial-channel-events.html">fabric-client: How to use the channel-based event service</a></li><li><a href="tutorial-discovery.html">fabric-client: How to use the discovery service</a></li><li><a href="tutorial-event-checkpointer.html">fabric-network: How to replay missed events</a></li><li><a href="tutorial-event-hub-management.html">fabric-network: How to automatically select and reconnect to event hubs</a></li><li><a href="tutorial-grpc-settings.html">fabric-client: How to set gRPC settings</a></li><li><a href="tutorial-handlers.html">fabric-client: How to use the endorsement and commit handlers</a></li><li><a href="tutorial-listening-to-events.html">fabric-network: How to listen to events</a></li><li><a href="tutorial-logging.html">fabric-client: How to use logging</a></li><li><a href="tutorial-metadata-chaincode.html">fabric-client: How to add CouchDB indexes during chaincode installation</a></li><li><a href="tutorial-mutual-tls.html">fabric-client: How to configure mutual TLS</a></li><li><a href="tutorial-network-config.html">fabric-client: How to use a common connection profile</a></li><li><a href="tutorial-private-data.html">How to use private data</a></li><li><a href="tutorial-query-peers.html">fabric-network: How to select peers for evaluating transactions (queries)</a></li><li><a href="tutorial-sign-transaction-offline.html">Working with an offline private key</a></li><li><a href="tutorial-transaction-commit-events.html">fabric-network: How to wait for transactions to be committed to the ledger</a></li><li><a href="tutorial-wallet.html">fabric-network: Using wallets to manage identities</a></li></ul><h3>Global</h3><ul><li><a href="global.html#CLIENT">CLIENT</a></li><li><a href="global.html#finalPackage">finalPackage</a></li><li><a href="global.html#HFAFFILIATIONMGR">HFAFFILIATIONMGR</a></li><li><a href="global.html#HFGENCRL">HFGENCRL</a></li><li><a href="global.html#HFINTERMEDIATECA">HFINTERMEDIATECA</a></li><li><a href="global.html#HFREGISTRARATTRIBUTES">HFREGISTRARATTRIBUTES</a></li><li><a href="global.html#HFREGISTRARDELEGATEROLES">HFREGISTRARDELEGATEROLES</a></li><li><a href="global.html#HFREGISTRARROLES">HFREGISTRARROLES</a></li><li><a href="global.html#HFREVOKER">HFREVOKER</a></li><li><a href="global.html#loadConfigGroup">loadConfigGroup</a></li><li><a href="global.html#loadConfigValue">loadConfigValue</a></li><li><a href="global.html#ORDERER">ORDERER</a></li><li><a href="global.html#package">package</a></li><li><a href="global.html#PEER">PEER</a></li><li><a href="global.html#toEnvelope">toEnvelope</a></li><li><a href="global.html#USER">USER</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Fri Dec 20 2019 11:13:07 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
